#!/usr/bin/env bash

shopt -s extglob

source $ME_UTIL
LIB_ME_DIR=$ME_LIB_DIR/me
LIB_PKG_DIR=$ME_LIB_DIR/me-packages

usage() {
  local subcmd

  printf "me <subcommand> [<args>]\n\n"
  printf "Subcommands:\n"
  printf "  %-12s%s\n" "list" "List all available packages"
  printf "  %-12s%s\n" "install" "Install packages"
  printf "  %-12s%s\n" "update" "Update packages"
  printf "  %-12s%s\n" "remove" "Remove packages"

  for subcmd in $(find $LIB_ME_DIR -name 'me-*' -printf "%f\n" | cut -c 4-); do
    printf "  %-12s%s\n" \
      "$subcmd"  "$(sed -nr '2 s/#\s*(.*)/\1/p' $LIB_ME_DIR/me-$subcmd)"
  done
}

package() {
  local method=$1 pkg
  case $method in
    list )
      IFS=$'\n'
      for pkg in $(ls "$LIB_PKG_DIR"); do
        if [[ -f $ME_BASHRC_DIR/$pkg ]]; then
          printf "%-12s${ME_ANSI_BOLD}${ME_ANSI_BLUE}%s${ME_ANSI_END}\n" \
            "${pkg%\.sh}" "enable"
        else
          printf "%-12s${ME_ANSI_BOLD}${ME_ANSI_RED}%s${ME_ANSI_END}\n" \
            "${pkg%\.sh}" "disable"
        fi
      done
      ;;

    install|update|remove )
      shift
      for pkg in "$@"; do
        [[ ! -f $LIB_PKG_DIR/$pkg.sh ]] &&
          _me_die "$ME_ES_UNKNOWN_PACKAGE" "Unknown package."

        set -e
        bash "$LIB_PKG_DIR/$pkg.sh" "$method"
        set +e

        [[ $method =~ ^install$|^update$ ]] &&
          ln -vsf "$LIB_PKG_DIR/$pkg.sh" "$ME_BASHRC_DIR/$pkg.sh"
        [[ $method == remove ]] &&
          rm -vf "$ME_BASHRC_DIR/$pkg.sh"

        _me_info "Please restart bash to make changes effect."
      done
      ;;

    * ) _me_die "$ME_ES_UNKNOWN_ARGUMENT" "Unknown argument." ;;
  esac
}

# main
case $1 in
  list    ) package list; exit 0 ;;
  install ) shift; package install "$@"; exit 0 ;;
  update  ) shift; package update "$@";  exit 0 ;;
  remove  ) shift; package remove "$@";  exit 0 ;;
esac

if find $LIB_ME_DIR -name 'me-*' -printf "%f\n" | grep -E "^me-$1$" &>/dev/null; then
  "$LIB_ME_DIR/me-$1" "${@:2}"
else
  usage
fi
